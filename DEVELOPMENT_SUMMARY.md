# 保険営業ロールプレイ訓練システム 開発まとめ

## 開発概要

### システム名
保険営業ロールプレイ訓練システム

### 開発目的
保険営業の初心者が、金融リテラシーが高い見込み客（投資信託やつみたてNISAで資産運用をしている顧客）への対応力を向上させるための訓練システムを構築。いつでもどこでも練習できる環境を提供し、プロの営業ノウハウを可視化することで、チーム全体のスキル向上を目指す。

---

## 主要機能

### 1. ロープレ練習機能（/chat）
- **概要**: ユーザーが保険営業担当者の役割を担い、AIが金融リテラシーが高い見込み客として応答
- **特徴**:
  - リアルタイムでの対話形式
  - 投資優先の考え方を持つリアルな見込み客設定
  - 高額療養費制度などの公的制度への理解がある設定
  - 費用対効果を重視し、論理的に質問してくる
- **カスタマイズ**: 見込み客の年齢（18〜70歳）、性別、結婚状況

### 2. 営業トーク参考機能（/demo）
- **概要**: AI営業マンとAI見込み客の会話を自動生成し、プロの営業トークを学習
- **特徴**:
  - 2つのAIペルソナが交互に会話
  - 営業マン・見込み客それぞれに専用プロンプト
  - リアルタイムで1ターンずつ生成・表示
- **カスタマイズ**:
  - 見込み客の属性（年齢、性別、結婚状況、名前）
  - 保険商品（がん保険、医療保険、生命保険、介護保険、学資保険、個人年金保険）
  - 会話のターン数（1〜10ターン）

---

## 技術スタック

### フロントエンド
- **Next.js 15 (App Router)**: 最新のReactフレームワーク
- **React 19**: UIコンポーネント構築
- **TypeScript**: 型安全性の確保
- **Tailwind CSS**: レスポンシブなスタイリング

### バックエンド
- **Next.js API Routes**: サーバーサイドAPI
- **Prisma ORM**: データベースアクセス層
- **SQLite (開発) / PostgreSQL (本番)**: データ永続化

### AI/ML
- **AWS Bedrock Runtime**: Claude 3.5 Sonnetとの連携
- **カスタムプロンプトエンジニアリング**: 役割別の会話生成

### 認証・セキュリティ
- **JWT**: セッション管理
- **Argon2**: パスワードハッシュ化

---

## 開発の流れ

### フェーズ1: 基本機能の実装
1. プロジェクトセットアップ（Next.js、Prisma、認証）
2. ロープレ練習機能の実装
3. AWS Bedrock連携の実装
4. 基本的なUI構築

### フェーズ2: エラー修正と改善
1. TypeScriptビルドエラーの修正
2. Enter キー送信の無効化
3. 音声機能のエラー対応（ブラウザ権限）
4. Bedrock API の会話開始エラー修正

### フェーズ3: 営業トーク参考機能の追加
1. デモページの新規作成
2. AI営業マンプロンプトの設計
3. 会話生成APIの実装
4. UIのチャット形式への変更

### フェーズ4: 設定機能の拡張
1. 詳細設定シートの作成（年齢ドロップダウン、性別、結婚状況）
2. 保険商品選択機能の追加（6種類）
3. 見込み客の名前カスタマイズ機能

### フェーズ5: プロンプト最適化
1. 営業マンプロンプトの改修（業界横断的フレームワーク導入）
2. 見込み客プロンプトの改修（段階的な情報開示）
3. 文章形式への変更（自然な会話生成のため）
4. プロンプトの簡潔化（トークン制限への対応）

### フェーズ6: API設計の改善
1. 初回挨拶問題の解決
2. ターン単位からメッセージ単位への変更
3. 営業マンと見込み客の個別API呼び出し
4. リアルタイム表示の実装

---

## 工夫した点

### 1. プロンプトエンジニアリング

#### 営業マンプロンプトの設計
- **ペルソナ設定**: 経験15年のベテラン営業マンという明確なキャラクター設定
- **会話フロー**: 共感 → 質問（1〜2件）→ 小さな合意という構造化された流れ
- **コンプライアンス重視**: 断定表現を避け、「条件次第」「一例」として説明するよう指示
- **質問数の制限**: 一度に複数の質問をしないよう、1〜2件に制限
- **投資の尊重**: 投資を否定せず、保険の固有価値（タイミング、確実性、収入減カバー）を提示

#### 見込み客プロンプトの設計
- **リアルな設定**: 金融リテラシーが高く、投資信託やつみたてNISAで資産運用している設定
- **段階的な情報開示**: 聞かれるまで全ての情報を出さない、現実的な応答
- **慎重な姿勢**: 素直だが慎重、即断しない、小さな合意で段階的に検討を進める
- **バランスの取れた応答**: 納得点と不安点をバランスよく述べる

#### プロンプトの最適化
- **トークン数削減**: 当初13.6KB → 最終6.6KB（約52%削減）
- **文章形式**: 箇条書きから文章形式に変更し、AIが自然な会話を生成しやすく
- **簡潔性**: 要点を絞り、冗長な説明を削除
- **禁止事項の明確化**: 不適切な応答を防ぐ明確なガイドライン

### 2. API設計の改善

#### 初回挨拶問題の解決
- **問題**: 営業マンが毎回「こんにちは」から始まってしまう
- **解決**: 初回と2回目以降でプロンプトを分離
  - 初回: 「まずは自然な挨拶から始めて...」
  - 2回目以降: 「会話を続けてください。挨拶は不要です」

#### メッセージ単位の生成
- **問題**: ターン単位での生成では、営業マンと見込み客の会話がまとめて返ってくる
- **解決**:
  - API に `role: 'salesman' | 'prospect'` パラメータを追加
  - 営業マン、見込み客を個別に呼び出し
  - それぞれの応答を受け取り次第、即座に画面表示

#### 会話履歴の管理
- **工夫**: 営業マンと見込み客で別々の会話履歴を管理
  - `salesmanHistory`: 営業マン視点の履歴
  - `prospectHistory`: 見込み客視点の履歴
  - 相手の発言を自分の履歴に `user` として追加

### 3. UI/UX の設計

#### リアルタイム表示
- **実装**: メッセージを1つずつ生成して即座に表示
- **効果**: ユーザーが会話の流れをリアルタイムで追える

#### 自動スクロール
- **実装**: 新しいメッセージが追加されたら自動的に最下部にスクロール
- **コード**: `useEffect` と `scrollIntoView` を使用

#### チャット形式のUI
- **デザイン**:
  - 営業マン: 青い吹き出し（右寄せ）
  - 見込み客: 白い吹き出し（左寄せ）
  - タイムスタンプと役割名を表示

#### ローディング表示
- **実装**:
  - 会話生成中は「ターン X / Y を生成中...」と表示
  - アニメーション付きのローディングインジケーター

### 4. カスタマイズ機能

#### 詳細な顧客属性設定
- **年齢**: ドロップダウンで18〜70歳から選択
- **性別**: ラジオボタンで選択
- **結婚状況**: ドロップダウンで選択（独身/既婚/離婚）
- **名前**: テキスト入力でカスタマイズ可能

#### 保険商品の選択
- **6種類の商品**: がん保険、医療保険、生命保険、介護保険、学資保険、個人年金保険
- **プロンプトへの反映**: 選択した商品に応じて営業マンの提案内容が変化

#### 設定のプレビュー
- **実装**: 設定シート内でリアルタイムプレビュー表示
- **効果**: 設定内容を確認してから保存可能

#### 設定の永続化
- **実装**: LocalStorageに設定を保存
- **効果**: ページリロード後も設定が保持される

### 5. セキュリティ対策

#### パスワードの安全な管理
- **Argon2**: 最新の安全なハッシュアルゴリズムを使用
- **ソルト**: 各パスワードに一意のソルトを自動生成

#### JWT認証
- **ステートレス**: サーバー側でセッション管理不要
- **環境変数**: JWT秘密鍵を環境変数で管理

#### TypeScriptによる型安全性
- **型定義**: 全てのデータ構造を型定義
- **コンパイル時のエラー検出**: バグの早期発見

### 6. データベース設計

#### 会話履歴の永続化
- **設計**: Conversations テーブルと Messages テーブルで管理
- **効果**: 過去の練習内容を振り返り可能

#### JSON形式での柔軟な設定保存
- **実装**: 顧客属性を JSON 形式で Conversations テーブルに保存
- **効果**: スキーマ変更なしで新しい設定項目を追加可能

#### ユーザーごとの会話管理
- **設計**: userId で会話を分離
- **効果**: プライバシー保護とマルチユーザー対応

---

## 技術的なチャレンジと解決

### チャレンジ1: プロンプトの長さとトークン制限
- **問題**: 詳細なプロンプトが長すぎて Bedrock がエラーを返す
- **解決**:
  - プロンプトを52%削減（13.6KB → 6.6KB）
  - 要点を絞り、冗長な説明を削除
  - 文章形式を維持しながら簡潔化

### チャレンジ2: 自然な会話の生成
- **問題**: AIの応答が箇条書き的で不自然
- **解決**:
  - プロンプトを文章形式に変更
  - 「〜してください」という指示形式に統一
  - 具体的な会話例を削除（AIの創造性を阻害しないため）

### チャレンジ3: 営業マンの初回挨拶問題
- **問題**: 毎ターンで「こんにちは」と挨拶してしまう
- **解決**:
  - 初回と2回目以降でプロンプトを分離
  - 会話履歴の長さで判定

### チャレンジ4: リアルタイム表示の実装
- **問題**: ターン単位の生成では会話の流れが分かりにくい
- **解決**:
  - APIを営業マンと見込み客で分離
  - メッセージを1つずつ生成して即座に表示
  - React の状態管理を活用

### チャレンジ5: 2つのAIペルソナの調整
- **問題**: 営業マンと見込み客の会話が噛み合わない
- **解決**:
  - それぞれに専用の会話履歴を管理
  - 相手の発言を自分の履歴に追加
  - プロンプトで会話スタンスを明確に定義

---

## Claude Code を使った開発の利点

### 1. 対話的な開発
- 要件を詰めながら段階的に実装
- エラーが出たら即座に修正提案
- 「これをこうしたい」という要望に柔軟に対応

### 2. ベストプラクティスの適用
- Next.js 15 の App Router を正しく使用
- TypeScript の型定義を適切に実装
- セキュリティ対策を標準的に実装

### 3. 迅速なプロトタイピング
- 新機能の追加が短時間で可能
- UIの変更も迅速に対応
- プロンプトの試行錯誤を効率的にサポート

### 4. エラー対応の効率化
- エラーメッセージから原因を特定
- 修正案を即座に提示
- ビルドエラーも含めて対応

### 5. ドキュメント生成
- コードの説明を自動生成
- README やプロンプトの作成をサポート
- 開発まとめの作成も可能

---

## 今後の展開

### 機能拡張のアイデア
1. **フィードバック機能**: 営業トークの評価とアドバイス
2. **学習記録機能**: 練習履歴の可視化と成長トラッキング
3. **シナリオバリエーション**: 他業界や商品への対応拡張
4. **音声対応**: 音声入力・出力機能の強化

### 期待される成果
- 営業初心者の早期戦力化
- 営業チーム全体の提案力向上
- 継続的な学習文化の醸成
- 難易度の高い顧客への対応力強化

---

## まとめ

### システムの価値
- いつでもどこでも営業訓練が可能
- AIによる実践的な対話訓練
- プロの営業ノウハウの可視化
- チーム全体のスキル向上に貢献

### 技術的な達成
- 最新技術スタックの採用（Next.js 15、React 19）
- AWS Bedrock による高度な会話生成
- 柔軟なカスタマイズ機能の実装
- セキュアな認証・データ管理

### 工夫の集大成
- プロンプトエンジニアリングの最適化
- 自然な会話を生成する設計
- ユーザビリティを重視したUI/UX
- 拡張性の高いアーキテクチャ

### Claude Code の活用
- 対話的な開発で要件を詰めながら迅速に実装
- ベストプラクティスに準拠した高品質なコード
- 複雑なプロンプトエンジニアリングをサポート
- エラー対応や最適化を効率的に実施
